# Initialize Kubernetes with kubeadm
sudo kubeadm init --apiserver-advertise-address=10.200.3.99 --pod-network-cidr=10.244.0.0/16 # Flannel CNI plugin.
sudo kubeadm init --pod-network-cidr=192.168.0.0/16 # Calico network

# Configure kubectl for the Default User
mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config

# Install Flannel CNI Plugin
kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
# Calico network
kubectl apply -f https://docs.projectcalico.org/manifests/calico.yaml


# Join the node to the Kubernetes Cluster (change based on initialized info)
sudo kubeadm token create --print-join-command
e.g., sudo kubeadm join 10.200.3.99:6443 --token f7gy7a.p4x0xulpaclrofof --discovery-token-ca-cert-hash sha256:e0a79801d11a3cc27100024462067307de151b5dfe4e4ce17744a6d68ab10ab2

# Apply Deployments and Services on the Server
kubectl apply -f k8s/configmaps/opa-fairness-policies.yaml
kubectl apply -f k8s/configmaps/opa-reliability-policies.yaml
kubectl apply -f k8s/configmaps/opa-explainability-policies.yaml

kubectl apply -f k8s/services/opa-service.yaml
kubectl apply -f k8s/services/edge_processing_service.yaml
kubectl apply -f k8s/services/edge_device_service.yaml

kubectl apply -f k8s/deployments/opa-deployment.yaml
kubectl apply -f k8s/deployments/edge_processing_deployment.yaml
kubectl apply -f k8s/deployments/edge_device_deployment.yaml

kubectl delete -f k8s/configmaps/opa-fairness-policies.yaml
kubectl delete -f k8s/configmaps/opa-reliability-policies.yaml
kubectl delete -f k8s/configmaps/opa-explainability-policies.yaml

kubectl delete -f k8s/services/opa-service.yaml
kubectl delete -f k8s/services/edge_processing_service.yaml
kubectl delete -f k8s/services/edge_device_service.yaml

kubectl delete -f k8s/deployments/opa-deployment.yaml
kubectl delete -f k8s/deployments/edge_processing_deployment.yaml
kubectl delete -f k8s/deployments/edge_device_deployment.yaml

# Verify Cluster Status
kubectl get nodes
kubectl get pods --all-namespaces
kubectl get services

kubectl describe node <>

sudo lsof -i :10250
sudo swapoff -a


# Reset the cluster, remove all cluster configurations.
   sudo kubeadm reset

# docker builds
## Rebuild Edge Device Image
   docker build -f docker/edge_device/Dockerfile -t edgemlops/edge-device:latest .
   docker push edgemlops/edge_device:latest

   docker buildx build -f docker/edge_device/Dockerfile --platform linux/amd64,linux/arm64 -t edgemlops/edge-device:latest --push .

## Rebuild Edge Processing Server Image
   docker build -f docker/edge_processing_server/Dockerfile -t edgemlops/edge-processing-server:latest .
   docker push edgemlops/edge-processing-server:latest

   docker buildx build -f docker/edge_processing_server/Dockerfile --platform linux/amd64,linux/arm64 -t edgemlops/edge-processing-server:latest --push .